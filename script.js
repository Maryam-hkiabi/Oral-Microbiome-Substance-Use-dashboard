$(document).ready(function () {
  const csvURL = "https://raw.githubusercontent.com/Maryam-hkiabi/Oral-Microbiome-Substance-Use-dashboard/refs/heads/main/data/associated_data_clean.csv";
  const bacteriaData = [{'Bacteria': 'Prevotella', 'Level': 'Genus', 'Mentions': 31}, {'Bacteria': 'Bacteroidetes', 'Level': 'Phylum', 'Mentions': 31}, {'Bacteria': 'Veillonella', 'Level': 'Genus', 'Mentions': 27}, {'Bacteria': 'Smokers', 'Level': 'Strain', 'Mentions': 22}, {'Bacteria': 'Firmicutes', 'Level': 'Phylum', 'Mentions': 22}, {'Bacteria': 'Streptococcus', 'Level': 'Genus', 'Mentions': 19}, {'Bacteria': 'Oral', 'Level': 'Strain', 'Mentions': 15}, {'Bacteria': 'Fusobacteria', 'Level': 'Phylum', 'Mentions': 15}, {'Bacteria': 'Proteobacteria', 'Level': 'Phylum', 'Mentions': 13}, {'Bacteria': 'Porphyromonas', 'Level': 'Genus', 'Mentions': 12}, {'Bacteria': 'Fusobacterium', 'Level': 'Genus', 'Mentions': 12}, {'Bacteria': 'Megasphaera', 'Level': 'Strain', 'Mentions': 12}, {'Bacteria': 'Changes', 'Level': 'Strain', 'Mentions': 11}, {'Bacteria': 'Treponema', 'Level': 'Genus', 'Mentions': 11}, {'Bacteria': 'Microbiome', 'Level': 'Strain', 'Mentions': 10}, {'Bacteria': 'Higher abundance in', 'Level': 'Strain', 'Mentions': 10}, {'Bacteria': 'Users', 'Level': 'Strain', 'Mentions': 8}, {'Bacteria': 'Actinomyces', 'Level': 'Genus', 'Mentions': 8}, {'Bacteria': 'Haemophilus', 'Level': 'Genus', 'Mentions': 7}, {'Bacteria': 'Species', 'Level': 'Strain', 'Mentions': 7}, {'Bacteria': 'Spirochaetes', 'Level': 'Phylum', 'Mentions': 7}, {'Bacteria': 'Rothia', 'Level': 'Genus', 'Mentions': 6}, {'Bacteria': 'Peptostreptococcus', 'Level': 'Strain', 'Mentions': 6}, {'Bacteria': 'Selenomonas', 'Level': 'Strain', 'Mentions': 5}, {'Bacteria': 'Lactobacillus', 'Level': 'Genus', 'Mentions': 5}, {'Bacteria': 'Filifactor', 'Level': 'Strain', 'Mentions': 5}, {'Bacteria': 'Actinobacteriota', 'Level': 'Strain', 'Mentions': 4}, {'Bacteria': 'Actinobacteria', 'Level': 'Phylum', 'Mentions': 4}, {'Bacteria': 'Leptotrichia', 'Level': 'Genus', 'Mentions': 4}, {'Bacteria': 'Tobacco', 'Level': 'Strain', 'Mentions': 4}, {'Bacteria': 'Granulicatella', 'Level': 'Strain', 'Mentions': 4}, {'Bacteria': 'Neisseria', 'Level': 'Genus', 'Mentions': 4}, {'Bacteria': 'Campylobacter', 'Level': 'Genus', 'Mentions': 4}, {'Bacteria': 'Cigarette', 'Level': 'Strain', 'Mentions': 4}, {'Bacteria': 'Individuals with', 'Level': 'Strain', 'Mentions': 3}, {'Bacteria': 'Tannerella', 'Level': 'Genus', 'Mentions': 3}, {'Bacteria': 'Escherichia', 'Level': 'Strain', 'Mentions': 3}, {'Bacteria': 'Gemella', 'Level': 'Strain', 'Mentions': 3}, {'Bacteria': 'Capnocytophaga', 'Level': 'Genus', 'Mentions': 3}, {'Bacteria': 'Atopobium', 'Level': 'Strain', 'Mentions': 3}, {'Bacteria': 'Veillonella dispar', 'Level': 'Strain', 'Mentions': 3}, {'Bacteria': 'Alloprevotella', 'Level': 'Strain', 'Mentions': 3}, {'Bacteria': 'Desulfobulbus', 'Level': 'Strain', 'Mentions': 3}, {'Bacteria': 'Periodontitis', 'Level': 'Strain', 'Mentions': 3}, {'Bacteria': 'Patescibacteria', 'Level': 'Strain', 'Mentions': 3}, {'Bacteria': 'Aggregatibacter', 'Level': 'Strain', 'Mentions': 3}, {'Bacteria': 'Patients', 'Level': 'Strain', 'Mentions': 3}, {'Bacteria': 'Streptococcus mutans', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Shigella', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Olsenella uli', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Sphaerochaeta', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Cancer', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Drinkers', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Medwakh smokers', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Cigarette smokers', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Solobacterium', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Streptococcus sanguinis', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Olsenella', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Tannerella forsythia', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Dialister', 'Level': 'Genus', 'Mentions': 2}, {'Bacteria': 'Parvimonas', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Shisha smokers', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Porphyromonas endodontalis', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Prevotella denticola', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Actinomycetaceae', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Fusobacterium nucleatum', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Users with', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Treponema sp', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Bacteroidales', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Health', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Anaeroglobus', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Alcohol', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Pseudomonas', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Prevotellaceae', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'In smokers', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Bacteroidota', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Klebsiella', 'Level': 'Strain', 'Mentions': 2}, {'Bacteria': 'Filifactor sp', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Bulleidia', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Bulleidia moorei', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Campylobacter gracilis', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Campylobacter species', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Campylobacteraceae', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Filifactor alocis', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Lactobacillus oris', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Filifactor spp', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Fretibacterium', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Lactobacillus fermentum', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Lactobacillus gasseri', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Lactobacillus murinus', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Bulledia', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Bulledia extructa', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Anaerobic genera including', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Bleeding', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Betaproteobacteria', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Families', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Cases', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Cardiobacteriaceae', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Non', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Candidatus', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Actinomyces graevenitzzi and', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Actinomyces meyeri and', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Actinomyces odontolyticus', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Actinomyces odontolyticus enriched', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'After antibiotic use', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Leptotrichiaceae', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Anaeroglobus geminatus', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Anaerovorax', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Ascomycota', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Bacteroides', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Acinetobacter', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Neisseria at the', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Lesions', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'In participants who', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Heavy', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'High', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Highly abundant genera', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'In cannabis smokers', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Issues', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'In nonsmokers', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'In participants with', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Genus', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'In smoking periodontal', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Increased abundance of', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Increased in', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Increased overall microbial', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Individuals', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Eubacterium saphenum', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Gums', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Fusobacterium canifelinum', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Methamphetamine', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Neisseria spp', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Moraxella', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Mortierella', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Mouth', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Mycobiome', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Neisseria sicca', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Neisseria species', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Neisseria subflava', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Fusobacteriota', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Neisseriaceae', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'No specific genera', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Lactobacillaceae', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Lachnospiraceae in the', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Klebsiella sp', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Howardella', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Exposure', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Saccharibacteria', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Eubacterium', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Spirochaetidae', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Patescibacteria at the', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Synergistetes', 'Level': 'Phylum', 'Mentions': 1}, {'Bacteria': 'Paludibacter', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Opium', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Porphyromonas spp', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Shigella sp', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Tongue and floor', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Peptostreptococcaceae spp', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Significantly', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Shannon indexes', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Simpson', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Smokeless', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Traditional cigarette smokers', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Ulcers', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Streptococcus spp', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Streptococcus salivarius', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Tannerella spp', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Poor', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Sras group', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Porphyromonas gingivalis', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Starmerella', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Porphyromonas at the', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Porphromonas', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Stomatobaculum', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Pichia', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Veillonella spp', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Porphyromonas showed a', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Veillonella parvula', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Tenericutes', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Veillonella and', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Phylum', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Veillonella rogosae', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Smokers had a', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Smokers had slightly', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Erysipelotrichaceae and', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Corynebacterium', 'Level': 'Genus', 'Mentions': 1}, {'Bacteria': 'Certain', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Chewers and', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Children with', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Coffee', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Conditions', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Consumers', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Cyanobacteria', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Not explicitly listed', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Decreased aerobic', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Delftia', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Dependent', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Endomicrobium', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Enrichment in current', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Enterobacteriaceae', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Cardiobacterium', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Lactobacillus panis', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Smokers with', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Tonsillitis', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Sneathia', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Romboutsia', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Rhodococcus', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Sobs', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Proteobacteria at the', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Propionibacterium', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Prevotella spp', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Rothia spp', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Specific species identified', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Prevotella salivae', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Prevotella oris', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Prevotella melaninogenica', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Prevotella intermedia', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Prevotella histicola', 'Level': 'Strain', 'Mentions': 1}, {'Bacteria': 'Veillonellaceae', 'Level': 'Strain', 'Mentions': 1}];

  Papa.parse(csvURL, {
    download: true,
    header: true,
    complete: function(results) {
      const data = results.data.filter(row => row["article title"]);

      // Initialize bacteria filter dropdown
      function updateBacteriaDropdown(level) {
        const options = bacteriaData.filter(b => !level || b.Level === level);
        $('#bacteria-filter').empty().append('<option value="">All</option>');
        options.forEach(row => {
          $('#bacteria-filter').append(`<option value="${row.Bacteria}">${row.Bacteria}</option>`);
        });
      }

      // Setup basic filters
      const speciesSet = new Set();
      const substanceSet = new Set();
      data.forEach(row => {
        if (row["Species studied"]) speciesSet.add(row["Species studied"]);
        if (row["substance studied"]) substanceSet.add(row["substance studied"]);
      });
      speciesSet.forEach(s => $('#species-filter').append(`<option value="${s}">${s}</option>`));
      substanceSet.forEach(s => $('#substance-filter').append(`<option value="${s}">${s}</option>`));

      $('#bacteria-level-filter').on('change', function () {
        const level = $(this).val();
        updateBacteriaDropdown(level);
      });

      function populateTable(filteredData) {
        const tableBody = $('#data-table tbody');
        tableBody.empty();
        filteredData.forEach(row => {
          const link = row["data link"] ? `<a href="${row["data link"]}" target="_blank">View</a>` : "â€”";
          tableBody.append(`
            <tr>
              <td>${row["article title"]}</td>
              <td>${row["Species studied"]}</td>
              <td>${row["substance studied"]}</td>
              <td>${row["sample collection source"]}</td>
              <td>${row["what sequenced_y"]}</td>
              <td>${row["Higher abundance"]}</td>
              <td>${row["lower abundance"]}</td>
              <td>${row["No difference"]}</td>
              <td>${row["final results"]}</td>
              <td>${link}</td>
            </tr>
          `);
        });
        $('#data-table').DataTable();
      }

      populateTable(data);

      $('#species-filter, #substance-filter, #bacteria-filter').on('change', function () {
        const selectedSpecies = $('#species-filter').val();
        const selectedSubstance = $('#substance-filter').val();
        const selectedBacteria = $('#bacteria-filter').val();

        const filtered = data.filter(row => {
          const matchSpecies = !selectedSpecies || row["Species studied"] === selectedSpecies;
          const matchSubstance = !selectedSubstance || row["substance studied"] === selectedSubstance;
          const matchBacteria = !selectedBacteria || (row["Higher abundance"] && row["Higher abundance"].includes(selectedBacteria));
          return matchSpecies && matchSubstance && matchBacteria;
        });

        $('#data-table').DataTable().clear().destroy();
        populateTable(filtered);
      });
    }
  });
});
